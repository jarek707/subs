<!DOCTYPE html>
<html>
    <style>
        #controls {
            position:relative;
            float:left;
            clear:both;
            width:100%;
        }

        #controls > * {
                position:relative;
                float:left;
                margin:4px;
                border:1px solid black;
                padding:3px;
                border-radius:4px;
        }

        #controls div  {
            position:relative;
            float:left;
            margin-left:20px;
        }

        button {
            cursor:pointer;
        }

        input {
            width:100%;
        }

        video,
        .wrap {
            margin-top:20px;
            position:relative;
            float:left;
            width:500px;
            clear:both;
        }
        .wrap > * {
            position:relative;
            float:left;
        }

        .wrap textarea {
            width:100%;
            height:100px;
            font-size:14px;
        }

        .wrap input {
            width:80px;
            margin-right:2px;
        }
        .wrap .upd {
            margin-right:12px;
        }
        .wrap input#frameNo {
            width:40px;
        }
    </style>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var fileInput   = null
        var ta          = null;
        var start       = null;
        var end         = null;
        var frameNo     = null;

        $(document).ready(function(){
            fileInput   = document.getElementById('fileInput');
            ta          = document.getElementById('caption');
            start       = document.getElementById('start');
            end         = document.getElementById('end');
            frameNo     = document.getElementById('frameNo');

            $("#video-active").on(
                "timeupdate", 
                function(event){ onTrackedVideoFrame(this.currentTime); }
            );
            
            fileInput.addEventListener('change', function(e) {
                var file= fileInput.files[0];
                var textType = /text.*/;
                if (true) {
                //if (file.type.match(textType)) {
                    var reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = function(e) { Parse(reader.result); };
                } else {
                    ta.value = " file not supported " + file.type;
                }
            });
        });


        function frameChange(el, nextVal) {
            if (typeof nextVal != 'undefined')
                lI += parseInt(nextVal);
            else
                lI = el.value;
            console.log ( lI );

            var vid = document.getElementById('video-active');
            vid.currentTime = lines[lI][0]/1000;

            loadFrame(lI, true);
        }

        var lI = 0;
        var contents = "";
        var byLine = [];
        var lines = [];

        function findFrame(stT) {
            var i=lI;
            var inFrame = false;
            if (lines.length >= lI) lI = 1;

            try {
            if (stT < lines[lI][0] && lI > 0)
                for (i=lI; i>=0 ; i--) {
                    if (stT > lines[i][0]) {
                        inFrame = stT < lines[i][1];
                        lI = i;
                        break;
                    }
                }
            else
                for (i=lI; i<lines.length ; i++) {
                    if (stT < lines[i][1]) {
                        inFrame = stT > lines[i][0];
                        lI = i;
                        break;
                    }
                }
            } catch (e) {
                console.log(e);
                console.log(lines[lI] + "  " +  lI + "  " + lines.length);
                console.log(lines);
            }
            loadFrame(lI, inFrame);

        }

        function loadFrame(id, inFrame) {
            if (typeof inFrame == 'undefined') inFrame = true;

            ta.value = inFrame ? lines[id][2] : "";
            start.value = inFrame ? fromMs(lines[id][0]) : "";
            end.value = inFrame ? fromMs(lines[id][1]) : "";
            frameNo.value = inFrame ? id : "";
        }

        function onTrackedVideoFrame(currentTime){
            if (typeof lines != 'undefined' && typeof lines[0] != 'undefined') {
                findFrame(currentTime*1000);
                $("#current").text(fromMs(currentTime*1000));
            }
        }

        function jump(jumpInt) {
            var vid = document.getElementById('video-active');
            vid.currentTime -= jumpInt;
            vid.pause();
        }

        function Parse(cont) {
            byLine = cont.split('\n\n');
            for (var i=0; i<byLine.length; i++) {
                var l = byLine[i].split('\n');
                var subs = "";

                var ll = l[0].split('-->');
                if (ll.length > 1) {
                    for (var j=1; j<l.length; j++) subs += '\n' + l[j];
                    lines.push([toMs(ll[0].toString()), toMs(ll[1].toString()), subs.substring(1)]);
                } else {
                    for (var j=0; j<l.length; j++) subs += '\n' + l[j];
                    lines.push([toMs("00:00:00,000"), toMs("00:00:00,000"), subs.substring(1)]);
                }
            }
            console.log("File updated");
        }

        function toMs(inS) {
            if (inS == 0) return 0;
            inS = inS.toString();
            var sA = inS.indexOf(',') > -1 ? inS.split(',') : inS.split('.');
            var mils = parseInt(sA.pop());
            var tA = sA[0].split(':');
            var secs = parseInt(tA.pop()) * 1000;
            var mins = parseInt(tA.pop()) * 60000;
            var hurs = parseInt(tA.pop()) * 3600000;

            return hurs + mins + secs + mils;
        }

        function fromMs(stamp) {
            var hurs = Math.floor(stamp/3600000).toString();
            var rest = stamp-hurs*3600000;
            var mins = Math.floor(rest/60000).toString();
            rest = rest - mins*60000;
            var secs = Math.floor(rest/1000).toString();
            var mils = Math.floor(rest - secs*1000).toString();

            if (hurs.length == 1) hurs = '0' + hurs;
            if (mins.length == 1) mins = '0' + mins;
            if (secs.length == 1) secs = '0' + secs;

            if (mils.length == 1) mils = '00' + mils;
            if (mils.length == 2) mils = '0'  + mils;

            return hurs + ":" + mins + ":" + secs + "," + mils;
        }

        function syncTm(which) {
            var curEl = document.getElementById("current");
            console.log( curEl);
            console.log( curEl.value );
            if (typeof which == 'undefined') {
                end.value = curEl.innerText;
            } else {
                start.value = curEl.innerText;
            }
        }

        //console.log(toMs("00:03:11,123"));
        //console.log(fromMs(191123));
    </script>


    <body>
        <input type="file" id="fileInput" />
        <br />
        <video id="video-active" controls poster="akLogo.jpeg">
            <source src="v.mp4" />
            <track src="EZ.vtt" default kind="captions" srclang="en"/>
        </video>

        <div id="controls">
            <button onclick="jump(0.3)">-300ms</button>
            <button  onclick="jump(-0.3)">+300ms</button>
            <button  onclick="jump(1)">-1s</button>
            <button  onclick="jump(-1)">+1s</button>
            <button  onclick="jump(5)">-5s</button>
            <button  onclick="jump(-5)">+5s</button>
            <div id="current">0:00</div>
        </div>

        <div class="wrap">
            <input type="text" id='start' />
            <button class='upd' id="startUpd" onclick="syncTm(true)">Sync Start</button>

            <input type="text" id='end' />
            <button class='upd' id="endUpd" onclick="syncTm()">Sync End</button>

            <label for="frameNo">Frame:</label>
            <button id="prevFrame" onclick="frameChange(this,-1)">-</button>
            <input type="text" id='frameNo' onchange="frameChange(this)" />
            <button id="nextFrame" onclick="frameChange(this,1)">+</button>

            <textarea id='caption'></textarea>
            <button id="updTimes" onclic='updateTimes()'>Update Frame</button>
        </div>

        <script>
                                                                                                </script>
    </body>
</html>
