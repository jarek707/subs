<!DOCTYPE html>
<html>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var fileInput   = null
        var fileDisp    = null;
        var outEl       = null;

        $(document).ready(function(){
            fileInput   = document.getElementById('fileInput');
            fileDisp    = document.getElementById('list');
            outEl       = document.getElementById('list');

            $("#video-active").on(
                "timeupdate", 
                function(event){ onTrackedVideoFrame(this.currentTime); }
            );
            
            fileInput.addEventListener('change', function(e) {
                var file= fileInput.files[0];
                var textType = /text.*/;
                if (true) {
                //if (file.type.match(textType)) {
                    var reader = new FileReader();

                    reader.onload = function(e) {
                        //fileDisp.innerText = reader.result;
                        contents = reader.result;
                        parse(reader.result);
                    };

                    reader.readAsText(file);
                } else {
                    fileDisp.innerText= " file not supported " + file.type;
                }
            });
            }
        );

        var lI = 0;
        var contents = "";
        var byLine = [];
        var lines = [];

        function findFrame(stT) {
            var a = false;
            var b = false;
            var w = false;
            while (lI < lines.length) {
                a = stT > lines[lI][1];
                b = stT < lines[lI][0];
                if (a) console.log('above');
                console.log(stT > lines[lI][1]);
                console.log(stT + "  " + lines[lI][0] + "  " + lines[lI][1] + "  " + lines[lI+1][0] + "  "+ lI.toString());
                if (a && lines[lI+1][0]>stT) break;
                console.log('no break');

                if (b && lI>0) lI--;
                if (a) lI++;
            }

            if (!a && !b)
                outEl.innerText = lines[lI][2] + "  " + stT + "  " +lines[lI][0] + "  " + lI.toString();
        }

        function onTrackedVideoFrame(currentTime){
            if (typeof lines != 'undefined' && typeof lines[0] != 'undefined') {
                findFrame(toMs(currentTime));
                $("#current").text(stamp);
            }
        }

        function jump(jumpInt) {
            var vid = document.getElementById('video-active');
            console.log( vid );
            vid.currentTime -= jumpInt;
            vid.pause();
        }

        function parse(cont) {
            byLine = cont.split('\n\n');
            console.log(cont + " cont ");
            for (var i=0; i<byLine.length; i++) {
                var l = byLine[i].split('\n');
                var ll = l[0].split('-->');
                lines.push([toMs(ll[0].toString()), toMs(ll[1].toString()), l[1], l[2], l[3], l[4]]);
            }
        }

        function toMs(inS) {
            if (inS == 0) return 0;
            inS = inS.toString();
            var sA = inS.indexOf(',') > -1 ? inS.split(',') : inS.split('.');
            var mils = parseInt(sA.pop());
            var tA = sA[0].split(':');
            var secs = parseInt(tA.pop()) * 1000;
            var mins = parseInt(tA.pop()) * 60000;
            var hurs = parseInt(tA.pop()) * 3600000;

            return hurs + mins + secs + mils;
        }

        function fromMs(stamp) {
            var hurs = Math.floor(stamp/3600000).toString();
            var rest = stamp-hurs*3600000;
            var mins = Math.floor(rest/60000).toString();
            rest = rest - mins*60000;
            var secs = Math.floor(rest/1000).toString();
            var mils = Math.floor(rest - secs*1000).toString();

            if (hurs.length == 1) hurs = '0' + hurs;
            if (mins.length == 1) mins = '0' + mins;
            if (secs.length == 1) secs = '0' + secs;

            if (mils.length == 1) mils = '00' + mils;
            if (mils.length == 2) mils = '0'  + mils;

            return hurs + ":" + mins + ":" + secs + "," + mils;
        }

        console.log(toMs("00:03:11,123"));
        console.log(fromMs(191123));
    </script>

    <style>
        #controls > * {
                position:relative;
                float:left;
                margin:4px;
                border:1px solid black;
                padding:3px;
        }
        #controls div  {
            position:relative;
            float:left;
            margin-left:20px;
        }

        #list {
                position:relative;
                float:left;
                clear:both;
                margin-top:33px;
                border-top:1px solid red;
        }
        
    </style>

    <body>
        <video id="video-active" controls poster="akLogo.jpeg" style="width:50%">
            <source src="v.mp4" />
            <track src="EZ.vtt" default kind="captions" srclang="en"/>
        </video>

        <div id="controls">
            <a onclick="jump(0.3)">back 300</a>
            <a onclick="jump(-0.3)">forward 300</a>
            <div id="current">0:00</div>
        </div>

        <input type="file" id="fileInput" />
        <output id="list"></output>

        <script>
                                                                                                </script>
    </body>
</html>
